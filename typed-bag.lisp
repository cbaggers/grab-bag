(in-package #:grab-bag)

;; # TODO FOR TYPED VERSION
;;
;; - add and profile fast-find and fast-position

(defconstant +release-mode+ nil)

(defstruct %rummager-base)

(defmacro def-typed-bag (element-type &body eraser-instance)
  (assert (and (symbolp element-type)
	       (not (null element-type))
	       (= (length eraser-instance) 1)))
  (labels ((symb (&rest args) (values (intern (format nil "狺狎珞┅┅戾舄è忉绛豉疱簌礅Д豉疱洵忉绛骘颦屐屙孱舡豉疱┅蝓眄徵弪豉疱簌礅屐屙孱舡豉疱Л蝓眄徵弪┅ㄡ滗邃汜祆忉汶簌礅忉绛豉疱Л徜溴洵汜祆忉汶螬ㄥ翦铙轱簌礅忉绛豉疱Л屮翦铙轱瞟ㄨ镬弩轭轸屙簌礅忉绛豉疱Л栾戾蟓轭轸屙螬ㄩ翦憝汜汨簌礅忉绛豉疱Л轸屙汜汨濠ㄩ翦眢簌礅忉绛豉疱Л轸屙螬ㄩ翦眢麸汜汨瀛轭溟沐簌礅忉绛豉疱Л轸屙蟓麸汜汨瀛轭溟沐螬蝈盹鲥洵汜祆忉汶簌礅忉绛豉疱Л蝈盹鲥洵汜祆忉汶螬蝓眄徵弪簌礅忉绛豉疱Л蝓眄徵弪螬痱邃殂狒簌礅蝓眄徵弪豉疱Л痱邃殂狒濠ㄡ滗轸屙簌礅п滗轸屙麸屐屙孱舡豉疱Л忉绌蝈盹鲥轸屙簌礅蝈盹鲥轸屙骝镯屐屙孱舡豉疱Л忉绌蝈盹鲥犰簌礅蝈盹鲥犰飙骝镯屐屙孱舡豉疱Л忉绌ㄩ铋簌礅р徵镦屐屙孱舡豉疱А┅篝狎舡蝓眄徵轭簌礅蝓眄徵瀛屐屙孱舡豉疱Л忉绌篝镳蝓眄徵轭簌礅篝镳屐屙孱舡豉疱Л蝓眄徵轭绌蝓眄徵弪忉簌礅蝓眄徵弪豉疱Л忉绌蝓眄徵弪疳蝈铘簌礅蝓眄徵弪豉疱Л疳蝈铘┅ㄥ蜥箦ㄧ孱簌㈠蜥箦颌┅啜痱镧ㄤ彐篝蝓泗忉绛豉疱ㄩ翦眢磲脲狎蜥哄戾礤铘豉疱Ж矧屐屙孱舡豉疱铛祆横潢躞翎忪烘殪飙痫轭翦癌呼疱ㄡ蝌狴矧屐屙孱舡豉疱铛祆í┅ㄩ翦憝汜汨磲脲狎蜥哄戾礤铘豉疱Ж矧屐屙孱舡豉疱铛祆横潢躞翎忪烘殪飙痫轭翦癌呼疱ㄡ蝌狴矧屐屙孱舡豉疱铛祆í┅ㄩ翦眢麸汜汨瀛轭溟沐磲脲狎蜥哄戾礤铘豉疱ф轼铛横潢躞翎忪烘殪飙痫轭翦癌呼疱ㄡ蝌狴骈铛í┅ㄨ镬弩轭轸屙铋呼疱扉篝ㄡ滗邃汜祆忉汶磲脲狎蜥哄戾礤铘豉疱Ж骢钽糸镱ì忉绛豉疱屐屙孱舡豉疱舂横潢躞翎忪烘殪飙痫轭翦癌呼疱ㄡ蝌狴ㄦ躅泗轱ì忉绛豉疱屐屙孱舡豉疱舂í┅蝈盹鲥洵汜祆忉汶磲脲狎蜥哄戾礤铘豉疱Ж骢钽糸镱ì忉绛豉疱屐屙孱舡豉疱舂横潢躞翎忪烘殪飙痫轭翦癌呼疱ㄡ蝌狴ㄦ躅泗轱ì忉绛豉疱屐屙孱舡豉疱舂í┅ㄥ翦铙轱卑呼疱骈铛愆蝓眄徵弪ㄥ蝌矧Ⅱ蹴磲珏狎蜥黹篌轭纰呼疱ㄡ蝌狴ヲ蹴磲珏颦忉箦í┅┅ㄤ彐篝蝓泗ì蝓眄徵弪豉疱ê轭沆蹁ヲ蹴磲珏颦忉箦┅痱邃殂狒ㄥ蝌矧痱邃殂狒轶磲钿狒矧麸篝狎蝓眄徵轭纰呼疱ㄦ躅泗轱ì屐屙孱舡豉疱怙镬遽瞟ㄢ徵ㄥ蝌矧⑩徵黹篌轭纰呼疱忉绛豉疱疳蝈铘铋呼疱矧忉绛豉疱铛祆┅ㄤ彐礤翳镤痱轭舡镡赍泗è镡赍泗忉绛豉疱篝蝈犴ㄦ矧磲篝蝈犴ㄦ矧磲铋＜铝黔掀螬劲屐屙孱舡豉疱戾铉翳ì轸屙汜汨镡赍泗┅┅ㄤ彐礤翳镤痱轭舡镡赍泗è镡赍泗蝓眄徵弪豉疱篝蝈犴ㄦ矧磲篝蝈犴ㄦ矧磲铋＜艺屯燎乓葡噎铝怯掀螬螬劲屐屙孱舡豉疱戾铉翳ì轸屙汜汨ì蝓眄徵弪忉镡赍泗┅ì痱邃殂狒镡赍泗┅戾è弪狍弪戾è繇ㄦ轵篝弪狍弪轭篝犷沐┅ㄡ篌弪豉疱繇К屐屙孱舡豉疱┅繇皓┅灬忮祗èロ犭瀛轸屙蟓狎蜥ī磲脲狎蜥哄戾礤铘豉疱Ж矧屐屙孱舡豉疱铛祆横潢躞翎忪烘殪飙痫轭翦癌ē磲脲轸屙汜汨ī磲脲狎蜥哄戾礤铘豉疱Ж矧屐屙孱舡豉疱铛祆横潢躞翎忪烘殪飙痫轭翦癌ē磲脲汜祆忉汶狎蜥ī磲脲狎蜥哄戾礤铘豉疱Ж骢钽糸镱ì忉绛豉疱屐屙孱舡豉疱舂横潢躞翎忪烘殪飙痫轭翦癌ē蝈盹鲥轸屙骝镯汜汨ㄢ徵痫蟓轭轸屙狎蜥ㄤ邈灬蝈ì忉绛豉疱忉绌ㄦ轼铛痫蟓轭轸屙狎蜥┅戾舄è轸屙汜汨ì轸屙汜汨忉绌ㄩ钿屮汜汨ì轸屙蟓麸汜汨瀛轭溟沐忉绌痫蟓镦灬篝翳轭绛轭轸屙汜汨ū戾铉翳轸屙汜汨濠┅痫蟓镦翳轭绛麸忮蝈盹鲥洵轭轸屙汜汨ㄡ蝈轭溴汜汨痫蟓轭轸屙狎蜥┅换箦翩ㄡ蝈ì轸屙忉绌痫蟓轭轸屙狎蜥铋飑扉篝痫蟓镦灬篝翳轭绛轭轸屙汜汨痫蟓镦翳轭绛麸忮蝈盹鲥洵轭轸屙汜汨濠躅戾篌痫蟓镦灬篝翳轭绛轭轸屙汜汨痫蟓镦翳轭绛麸忮蝈盹鲥洵轭轸屙汜汨濠戾舄è灬篝翳轭绛轭轸屙汜汨ㄡ蝈轸屙汜汨痫蟓镦灬篝翳轭绛轭轸屙汜汨濠痫蟓轭轸屙狎蜥镦灬篝翳轭琬轭轸屙汜汨痫箝糸镱灬篝翳轭绛轭轸屙汜汨ì轸屙忉绌┅换箦翩ㄡ蝈轸屙汜汨痫蟓镦翳轭绛麸忮蝈盹鲥洵轭轸屙汜汨濠灬篝翳轭绛轭轸屙汜汨濠换箦翩ㄡ蝈轭溴汜汨痫蟓轭轸屙狎蜥镦灬篝翳轭琬轭轸屙汜汨濠ㄡ蝈轭溴汜汨痫蟓轭轸屙狎蜥┅┅躅戾篌蝈戾狍瀛盹溴箦翩ㄡ蝈轭溴汜汨痫蟓轭轸屙狎蜥暴箦翩ㄡ蝈轸屙汜汨痫蟓镦灬篝翳轭绛轭轸屙汜汨濠弪狍弪ㄤ邈ㄦ殪飙痫轭翦轸屙汜汨濠忉绌ē徜洵蝓眄徵弪ㄢ徵蝓眄徵弪ㄤ邈灬蝈ì忉绛豉疱忉绌ì蝓眄徵弪豉疱蝓眄徵弪┅躅戾篌ㄦ轭蝓眄徵弪ì蝓眄徵弪忉绌呼弩＇羼鲥泗矧瘐箬屮翦钿蝓眄徵弪ì蝓眄徵弪忉绌箦翩ì蝓眄徵弪疳蝈铘蝓眄徵弪忉绌祜镳烘矧轸屙横泸矬ì轸屙汜汨忉绌轰ē疳蝈铘镱徜溴蝓眄徵弪轸屙┅忉绌ē蝈盹鲥蝓眄徵弪蝓眄徵弪ㄤ邈灬蝈ì蝓眄徵弪豉疱蝓眄徵弪┅戾è忉ì蝓眄徵弪疳蝈铘蝓眄徵弪┅ㄤ邈灬蝈ì忉绛豉疱忉绌箦翩ì蝓眄徵弪忉绌ㄤ屐弭蝓眄徵弪ì蝓眄徵弪忉绌恒秕铘暴箦翩ì蝓眄徵弪疳蝈铘蝓眄徵弪铋飑忉绌ē疳蝈铘镱徜溴蝓眄徵弪轸屙ㄤ邈灬蝈ì蝓眄徵弪豉疱蝓眄徵弪ì屐屙孱舡豉疱轸屙┅麒孱ㄦ躅汜祆ì痱邃殂狒蝓眄徵弪轸屙ì徜洵轸屙ì蝓眄徵弪忉蝓眄徵弪轸屙┅ē疳蝈铘镱蝈盹鲥蝓眄徵弪轸屙ㄤ邈灬蝈ì蝓眄徵弪豉疱蝓眄徵弪ì屐屙孱舡豉疱轸屙┅ì蝈盹鲥轸屙ì蝓眄徵弪忉蝓眄徵弪轸屙铋飑┅ㄤ彐躅轭轸é镳糸镱犰黹瞽屮翦铙轱卑癌ㄤ邈灬蝈ㄦ轼铛黹瞽屮翦铙轱瞟ì簌礅ы犭瀛忉绛豉疱哄翦铙轱黹瞽屮翦铙轱候蹴磲珏蝮磲脲狎蜥哄戾礤铘豉疱К蝓眄徵弪豉疱横潢躞翎忪烘殪飙痫轭翦癌┅ㄤ彐躅簌礅т弩趄稆屐屙孱舡豉疱Л忉绌ㄢ徵ㄤ邈灬蝈ì忉绛豉疱忉绌ì蝈盹鲥犰忉绌箦翩ì徜溴洵汜祆忉汶忉绌ē磲脲汜祆忉汶狎蜥ì蝈盹鲥洵汜祆忉汶忉绌ē磲脲汜祆忉汶狎蜥┅铋飑ㄤ彐躅簌礅х弭轸屙蟓骝镯屐屙孱舡豉疱Л忉绌ㄢ徵ㄤ邈灬蝈ì忉绛豉疱忉绌ì轸屙汜汨忉绌ㄤ彐躅徜洵轸屙ㄢ徵轸屙ㄤ邈灬蝈ì忉绛豉疱忉绌ì屐屙孱舡豉疱轸屙┅躅戾篌ㄦ轭轸屙ì轸屙忉绌呼弩＇羼戾è屮翦铙轱ì屮翦铙轱忉绌┅ㄩì栾戾蟓轭轸屙忉绌戾è痫ì栾戾蟓轭轸屙忉绌┅箦翩ㄡ蝈ì轸屙忉绌椹轸屙箦翩ㄡ蝈ì轸屙蟓麸汜汨瀛轭溟沐忉绌椹戾铉翳ì轸屙汜汨忉绌┅痱镧鲥泗矧瘐箬屮翦钿戾铉翳ì轸屙汜汨忉绌ì轸屙蟓麸汜汨瀛轭溟沐忉绌鲥泗矧瘐箬屮翦钿轸屙ì轸屙忉绌屮翦铙轱瞟┅鲥泗矧瘐箬屮翦钿轸屙ì轸屙汜汨忉绌屮翦铙轱瞟┅祜镳烘矧蝓眄徵弪横泸矬ì蝓眄徵弪忉绌轰ē疳蝈铘镱徜溴蝓眄徵弪轸屙┅祜镳烘矧汜祆忉汶横泸矬ì徜溴洵汜祆忉汶忉绌轰ㄦ躅汜祆汜祆忉汶忉轸屙┅忉绌ㄤ彐躅蝈盹鲥轸屙ㄢ徵轸屙镳糸镱犰ㄥ蝌矧殒黹篌轭舂ㄤ邈灬蝈ì忉绛豉疱忉绌ì屐屙孱舡豉疱轸屙ㄢ镲戾犷弪蝻颦殒黹篌轭绌戾è痫痫箝糸镱轸屙ì轸屙忉绌呼弩＇羼┅ㄩ痫痱镧ē蝈盹鲥轸屙骝镯汜汨忉痫螬瘐箬痫ì栾戾蟓轭轸屙忉绌祜镳烘矧蝓眄徵弪横泸矬ì蝓眄徵弪忉绌轰ē疳蝈铘镱蝈盹鲥蝓眄徵弪轸屙┅祜镳烘矧汜祆忉汶横泸矬ì蝈盹鲥洵汜祆忉汶忉绌轰ㄦ躅汜祆汜祆忉汶忉轸屙┅忉绌麒孱弪蝻颦殒黹篌轭ㄥ蝌矧⑽轸屙轭忉螈轸屙忉绌┅┅ㄤ彐躅蝈盹鲥犰ㄢ徵ㄤ邈灬蝈ì忉绛豉疱忉绌戾è轸屙ì轸屙忉绌┅箦翩ì轸屙忉绌ē磲脲轸屙蟓狎蜥ì轸屙汜汨忉绌ē磲脲轸屙汜汨濠ì栾戾蟓轭轸屙忉绌铋ì徜溴洵汜祆忉汶忉绌ē磲脲汜祆忉汶狎蜥ì蝈盹鲥洵汜祆忉汶忉绌ē磲脲汜祆忉汶狎蜥┅祜镳烘矧蝓眄徵弪横泸矬ì蝓眄徵弪忉绌轰祜镳烘矧轸屙横泸矬轸屙轰ē疳蝈铘镱蝈盹鲥蝓眄徵弪轸屙┅祜镳烘矧汜祆忉汶横泸矬ì蝈盹鲥洵汜祆忉汶忉绌轰祜镳烘矧轸屙横泸矬轸屙轰ㄦ躅汜祆汜祆忉汶忉轸屙┅┅忉绌ㄤ彐躅簌礅п滗镱屐屙孱舡豉疱Л徜溴洵汜祆忉汶ㄢ徵汜祆忉汶ㄤ邈灬蝈ì忉绛豉疱忉绌è骢钽糸镱ì忉绛豉疱屐屙孱舡豉疱舂汜祆忉汶┅鲥泗矧瘐箬屮翦钿汜祆忉汶ì徜溴洵汜祆忉汶忉绌忉绌ㄤ彐躅簌礅п滗镱屐屙孱舡豉疱Л蝈盹鲥洵汜祆忉汶ㄢ徵汜祆忉汶ㄤ邈灬蝈ì忉绛豉疱忉绌è骢钽糸镱ì忉绛豉疱屐屙孱舡豉疱舂汜祆忉汶┅鲥泗矧瘐箬屮翦钿汜祆忉汶ì蝈盹鲥洵汜祆忉汶忉绌忉绌ㄤ彐躅簌礅蝈盹鲥镱屐屙孱舡豉疱Л徜溴洵汜祆忉汶ㄢ徵汜祆忉汶ㄤ邈灬蝈ì忉绛豉疱忉绌è骢钽糸镱ì忉绛豉疱屐屙孱舡豉疱舂汜祆忉汶┅箦翩ì蝈盹鲥洵汜祆忉汶忉绌ㄤ屐弭汜祆忉汶ì蝈盹鲥洵汜祆忉汶忉绌恒秕铘暴忉绌ㄤ彐躅簌礅蝈盹鲥镱屐屙孱舡豉疱Л蝈盹鲥洵汜祆忉汶ㄢ徵汜祆忉汶ㄤ邈灬蝈ì忉绛豉疱忉绌è骢钽糸镱ì忉绛豉疱屐屙孱舡豉疱舂汜祆忉汶┅箦翩ì蝈盹鲥洵汜祆忉汶忉绌ㄤ屐弭汜祆忉汶ì蝈盹鲥洵汜祆忉汶忉绌恒秕铘暴忉绌ㄤ彐躅篝狎舡蝓眄徵轭ㄢ徵矧蝓眄徵弪痱邃殂狒濠ㄤ邈灬蝈è骢钽糸镱ì屐屙孱舡豉疱怙镬遽瞟痱邃殂狒濠ㄥ豉疱汜箦忉绛矧蝓眄徵弪ì蝓眄徵弪豉疱ì篝狎舡蝓眄徵轭ì蝓眄徵弪忉忉绛矧蝓眄徵弪痱邃殂狒濠ì忉绛豉疱戾èì簌礅ы犭瀛蝓眄徵弪豉疱吼蝈溟汜翦痱邃殂狒吼狎孱忉绛矧蝓眄徵弪衡徵ì轭轸┅┅ē徜洵蝓眄徵弪忉绛矧蝓眄徵弪颟颟┅ㄤ彐躅篝镳蝓眄徵轭蝓眄徵濠ㄤ邈灬蝈ì蝓眄徵弪豉疱蝓眄徵濠ē蝈盹鲥蝓眄徵弪蝓眄徵濠┅┅┅